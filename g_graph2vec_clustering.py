import warnings
warnings.filterwarnings("ignore")


from util import read_json, write_json, read_csv_all, t_clustering
from config import all_func


def func2type_idx(func_name):
    for idx, func_list in enumerate(all_func):
        if func_name in func_list:
            return idx

    return 0


def make_data_graph2vec(user_name):
    now_output_path = './data/user_name/' + user_name + '_user_name.json'
    opcode_info = read_json(now_output_path)

    node2id = {}

    import os
    if not os.path.exists('./data/G_Graph2Vec_Data/{}/'.format(user_name)):
        os.makedirs('./data/G_Graph2Vec_Data/{}/'.format(user_name))

    for st, uuid in enumerate(opcode_info):
        sample = opcode_info[uuid]
        sample_g = {
            'edges': [],
            'features': {}
        }

        for ci in range(0, len(sample), 2):
            if sample[ci] not in node2id:
                node2id[sample[ci]] = len(node2id)
            if sample[ci + 1] not in node2id:
                node2id[sample[ci + 1]] = len(node2id)

            sample_g['edges'].append([node2id[sample[ci]], node2id[sample[ci + 1]]])
            sample_g['features'][node2id[sample[ci]]] = func2type_idx(sample[ci])
            sample_g['features'][node2id[sample[ci + 1]]] = func2type_idx(sample[ci + 1])

        write_json(sample_g, './data/G_Graph2Vec_Data/{}/{}.json'.format(user_name, str(st)))



result_json = {}
# 切换数据级“DS1” “DS2” “DS3”

ds_name_list=['DS1','DS2','DS3','DS4']

for ds_name in ds_name_list:
#    make_data_graph2vec(ds_name)


    csv_result = read_csv_all(',', 'F:/whh-malware-clustering/data/G_Graph2Vec_Data/result/result_{}.csv'.format(ds_name))
    for cr in csv_result:
        result_json[int(cr[0])] = cr[1:]

    x_t = []
    for ci in range(len(result_json)):
        x_t.append(result_json[ci])

    user_name = '{}_user_name'.format(ds_name)
    label_name = 'label_data_{}'.format(ds_name)
    label_info = read_json('./data/label_data/' + label_name + '.json')
    now_output_path = './data/user_name/' + user_name + '.json'
    opcode_info = read_json(now_output_path)
    uuid_list = []
    for uuid in opcode_info:
        uuid_list.append(uuid)

    import numpy as np

    x_t = np.array(x_t)
    index = np.random.permutation(len(x_t))
    x_t = x_t[index]
    uuid_list = np.array(uuid_list)[index]

    t_clustering(x_t, label_info=label_info, uuid_list=uuid_list)

